package com.amadeus.drools.rule.parser;

import java.io.InputStreamReader;
import java.util.ArrayList;
import java.util.List;

import org.apache.log4j.Logger;
import org.drools.compiler.builder.impl.KnowledgeBuilderImpl;
import org.drools.compiler.compiler.DialectCompiletimeRegistry;
import org.drools.compiler.compiler.DrlParser;
import org.drools.compiler.compiler.DroolsParserException;
import org.drools.compiler.lang.descr.AndDescr;
import org.drools.compiler.lang.descr.BaseDescr;
import org.drools.compiler.lang.descr.ExprConstraintDescr;
import org.drools.compiler.lang.descr.PackageDescr;
import org.drools.compiler.lang.descr.PatternDescr;
import org.drools.compiler.lang.descr.RuleDescr;
import org.drools.compiler.rule.builder.PatternBuilder;
import org.drools.compiler.rule.builder.RuleBuildContext;
import org.drools.compiler.rule.builder.dialect.mvel.MVELDialect;
import org.drools.core.definitions.InternalKnowledgePackage;
import org.drools.core.rule.RuleConditionElement;
import org.kie.internal.builder.conf.LanguageLevelOption;

import com.amadeus.drools.rule.model.Constraint;
import com.amadeus.drools.rule.model.Rule;

public class RuleParser {
	private static Logger logger = Logger.getLogger(RuleParser.class);
	DrlParser dp = new DrlParser(LanguageLevelOption.DRL6);
	protected String filename;
	protected PackageDescr pdesc = null;
	protected Rule rule = new Rule();
	RuleBuildContext context=null;

	public void setUp(String filename) {
		this.filename = filename;
		InputStreamReader is = new InputStreamReader(RuleParser.class.getResourceAsStream(filename));
		try {
			pdesc = dp.parse(is);
		} catch (DroolsParserException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}

	public Rule buildRuleFromDrl() {
		for (RuleDescr rdesc : pdesc.getRules()) {
			KnowledgeBuilderImpl pkgBuilder = new KnowledgeBuilderImpl();
			pkgBuilder.addPackage(pdesc);
			InternalKnowledgePackage pkg = pkgBuilder.getPackageRegistry(pdesc.getName()).getPackage();
			DialectCompiletimeRegistry dialectRegistry = pkgBuilder.getPackageRegistry(pdesc.getName())
					.getDialectCompiletimeRegistry();
			MVELDialect mvelDialect = (MVELDialect) dialectRegistry.getDialect("mvel");
			context = new RuleBuildContext(pkgBuilder, rdesc, dialectRegistry, pkg, mvelDialect);

			rule.setName(rdesc.getName());
			AndDescr lhs = rdesc.getLhs();
			buildConditions(lhs.getDescrs());
			for (BaseDescr bdescr : lhs.getDescrs()) {
				PatternDescr pdescr = (PatternDescr) bdescr;
				logger.info("Object Type " + pdescr.getObjectType());

				for (BaseDescr slc : pdescr.getSlottedConstraints()) {
					ExprConstraintDescr ecdescr = (ExprConstraintDescr) slc;
					logger.info(ecdescr.getText());
					String[] constraint = ecdescr.getText().split(" ");
					for (int i = 0; i < constraint.length; i++) {
						logger.debug(constraint[i]);
					}
				}
			}

			// consequence
			logger.info(rdesc.getConsequence());

			for (String keyconsequence : rdesc.getNamedConsequences().keySet())
				logger.info("key : " + keyconsequence);
		}

		return rule;
	}

	/**
	 * Simple way to get condition, we use a split to get attribute, comparator
	 * and value
	 * 
	 * @param bdescrs
	 */
	protected void buildConditionsBasedOnString(ArrayList<BaseDescr> bdescrs) {
		for (BaseDescr bdescr : bdescrs) {
			PatternDescr pdescr = (PatternDescr) bdescr;
			logger.debug("Object Type " + pdescr.getObjectType());
			Constraint condition = new Constraint();
			condition.setObjectType(pdescr.getObjectType());
			for (BaseDescr slc : pdescr.getSlottedConstraints()) {
				ExprConstraintDescr ecdescr = (ExprConstraintDescr) slc;
				logger.debug(ecdescr.getText());
				String[] constraint = ecdescr.getText().split(" ");
				condition.setAttribute(constraint[0]);
				condition.setOperand(constraint[1]);
				condition.setValue(constraint[2]);
			}
			rule.getConstraints().add(condition);
		}
	}



	protected void buildConditions(List<BaseDescr> bdescrs){
		for (BaseDescr bdescr : bdescrs) {
			PatternDescr pdescr = (PatternDescr) bdescr;
			logger.info(pdescr.getConstraint().toString());
			PatternBuilder patternBuilder = new PatternBuilder();
			
			RuleConditionElement rce = patternBuilder.build(context, pdescr);
			//go to inner declaration
			for(String keyInner : rce.getInnerDeclarations().keySet()){
				logger.info("Key Inner "+keyInner+ " Object Inner "+rce.getInnerDeclarations().get(keyInner).toString());
			}
			
			//go to outer declaration
			for(String keyOuter : rce.getOuterDeclarations().keySet()){
				logger.info("Key Outer "+keyOuter+ " Object Inner "+rce.getInnerDeclarations().get(keyOuter).toString());
			}
			
			logger.info(rce.getNestedElements().toString());
			logger.info("RCE : "+rce.toString());
			logger.debug("Object Type " + pdescr.getObjectType());
			
			
			Constraint condition = new Constraint();
			condition.setObjectType(pdescr.getObjectType());
			for (BaseDescr slc : pdescr.getSlottedConstraints()) {
				ExprConstraintDescr ecdescr = (ExprConstraintDescr) slc;
				logger.debug(ecdescr.getText());
				String[] constraint = ecdescr.getText().split(" ");
					condition.setAttribute(constraint[0]);
					condition.setOperand(constraint[1]);
					condition.setValue(constraint[2]);
			}
			rule.getConstraints().add(condition);
		}	
	}

}
